name: Update Tailscale

on:
  # Run weekly on Mondays at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current Tailscale version from base image
        id: check-version
        run: |
          echo "Checking latest Tailscale version from Docker Hub..."
          
          # Pull the latest tailscale/tailscale image
          docker pull tailscale/tailscale:latest
          
          # Get the Tailscale version from the image with error handling
          TAILSCALE_VERSION=$(docker run --rm tailscale/tailscale:latest tailscale version 2>/dev/null | head -n 1 | awk '{print $1}')
          
          if [ -z "$TAILSCALE_VERSION" ]; then
            echo "Error: Failed to extract Tailscale version"
            exit 1
          fi
          
          echo "Latest Tailscale version: $TAILSCALE_VERSION"
          echo "version=$TAILSCALE_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version has changed
        id: version-check
        run: |
          LATEST_VERSION="${{ steps.check-version.outputs.version }}"
          echo "Latest version from Docker Hub: $LATEST_VERSION"
          
          # Check if we have a previous version stored in the repo
          if [ -f ".tailscale-version" ]; then
            CURRENT_VERSION=$(cat .tailscale-version)
            echo "Current stored version: $CURRENT_VERSION"
            
            if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
              echo "No update needed - already at version $CURRENT_VERSION"
              echo "has_update=false" >> $GITHUB_OUTPUT
            else
              echo "Update available: $CURRENT_VERSION -> $LATEST_VERSION"
              echo "has_update=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous version found - triggering initial build"
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Update version file
        if: steps.version-check.outputs.has_update == 'true'
        run: |
          echo "${{ steps.check-version.outputs.version }}" > .tailscale-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .tailscale-version
          git commit -m "Update Tailscale version to ${{ steps.check-version.outputs.version }}"
          git push

      - name: Trigger Docker build workflow
        if: steps.version-check.outputs.has_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering Docker build to update to Tailscale version ${{ steps.check-version.outputs.version }}"
          if gh workflow run docker-publish.yml; then
            echo "Successfully triggered Docker build workflow"
          else
            echo "Error: Failed to trigger Docker build workflow"
            exit 1
          fi

      - name: Create summary
        run: |
          echo "## Tailscale Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Tailscale Version:** ${{ steps.check-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version-check.outputs.has_update }}" == "true" ]; then
            echo "✅ Docker build workflow has been triggered to rebuild with the latest Tailscale version." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Docker image will be rebuilt and pushed with the latest Tailscale base image." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No update needed - already using the latest version." >> $GITHUB_STEP_SUMMARY
          fi
